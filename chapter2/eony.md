# VARCHAR vs TEXT

## 공통점
- 문자열 속성 값 저장
- 최대 저장 사이즈 64KB로 동일

## 차이점
- VARCHAR는 지정된 글자 수만큼만 저장 (역시나 글자수)
- TEXT는 인덱스 생성 시 반드시 Prefix 길이 지정 필요
- TEXT는 표현식으로만 디폴트 값 지정 가능 (문법적인 부분 같아서 별로 중요하진 않은 듯)

## 일반적인 사용 형태
> 길이가 짧으면 VARCHAR, 길면 TEXT

<br>

## VARCHAR(5000) vs TEXT에선 뭐가 유리할까?

(1) VARCHAR
- 메모리 버퍼 공간을 할당해두고 값을 재활용할 수 있다!
- 따라서 컬럼 사용이 빈번하고 버퍼 사용을 위한 메모리 용량이 충분하면 VARCHAR 사용 시 오버헤드를 줄일 수 있음

(2) TEXT
- 따로 버퍼 사용하지 않고 그때그때 메모리 할당/해제

<br>

### VARCHAR 메모리 버퍼 관련 주의점

버퍼 사용 시 Row의 최대 사이즈 제한이 있음

만약 Row 하나에 VARCHAR(5000)처럼 큰 사이즈 할당이 필요한 컬럼들이 많을 경우 메모리 버퍼가 모자른 상황이 발생해 버퍼의 기대효과가 크지 않을 수 있음.

또한 VARCHAR 값을 메모리 버퍼에 올릴 때 실제 데이터 길이만큼을 올리는 것이 아니라 **최대 크기**를 메모리 버퍼에 올려버림 [블로그 참고](https://320hwany.tistory.com/m/95)

<br>

## VARCHAR(30) vs VARCHAR(255)에 대한 결정
- 실제 최대 사용하는 길이만큼 명시해야 메모리 효율 증가
- 문자열의 길이를 따로 저장하고 관리하는데(1강 참고), 30자 짜리 VARCHAR와 255자 짜리 VARCHAR는 각각 길이 관리를 위해 할당되는 공간이 미묘하게 다를 수 있음 (1 바이트 vs 2바이트)

<br>

## VARCHAR와 TEXT 모두에서 주의사항 (중요)
저장되는 값의 사이즈가 크면 **Off-Page(Overflow-page)** 형태로 데이터 저장될 수 있음

### Off-Page란?
InnoDB에선 하나의 레코드 크기가 데이터 페이지 절반크기보다 크면 VARCHAR 혹은 TEXT 컬럼 일부를 외부 페이지에 저장하도록 동작함.

실제 데이터 페이지에는 해당 외부 페이지에 대한 포인터만 가짐.

**Off-Page 컬럼 참조 여부에 따라 쿼리 처리 성능이 매우 달라짐 (외부 페이지 탐색 작업이 추가되므로)**

<br>

## 정리
- 저장되는 데이터 사이즈가 많이 크지 않고 컬럼 사용이 빈번, DB 메모리 용량 충분하면 VARCHAR 타입 권장
- 데이터 사이즈가 크고, 컬럼을 자주 사용하지 않고, ROW 사이즈 제한에 영향을 받고 싶지 않다면 TEXT 컬럼 사용 권장
- VARCHAR 쓸땐 최대길이 잘 설정해라 (버퍼 이점을 살리려면)
- SELECT 쿼리에는 필요한 컬럼만 명시
    - 테이블에 대형 데이터 저장되면 쿼리처리 성능 낮이짐 (Off-Page 문제도 발생 가능)
    - 커버링 인덱스 사용도 유도 가능
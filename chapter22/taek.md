# 커넥션 관리

- MySQL은 Oracle, PostgreSQL과 달리 프로세스 기반이 아닌 쓰레드 기반으로 동작한다.
  - 따라서 커넥션당 사용하는 메모리의 양이 적은 편
- 일반적으로는 커넥션당 16KB ~ 3MB 정도를 사용
- 커넥션이 너무 많아지는 것에 대해 주의를 해야 함

## 1. Max Connection 설정
- Server-Side Max Connection (max_connections)
  - 설정으로는 100k까지 가능하지만, 실질적으로는 최대 8k ~ 10k 수준임  

## 2. Connection Pool 설정
- Client-Side Connection Pool
  - 커넥션 풀 사용은 필수이며, 시작 설정은 최대 20 ~ 30
  - 처음부터 최대치를 너무 높게 잡으면 나중에 줄이기가 쉽지 않음
  - Min = Max * (70% ~ 90%) 권장
    - Min == Max로 설정해두는 것이 성능상 좋지만, 커넥션 부족 현상 판단 어려움
  - 애플리케이션 서버의 개수를 고려하여 커넥션 풀을 설정하는 것이 중요
  - 필요하다면 미들웨어를 활용해서 Server-Side 커넥션을 재활용하자
- Connect Timeout 설정
  - 커넥션 풀로부터 커넥션을 가져오는 시간을 제한
  - 인프라 여건에 맞춰서 3~10초 정도의 시간 설정을 사용
    - 커넥션을 못 가져올 경우 일반적으로 다른 Fallback 전략이 없음
    - 일시적인 DB 서버 과부하 시 커넥션 요청 및 취소 반복으로 오히려 성능에 악영향
    - 커넥션 가져오기 실패 시 재시도 없이 사용자에게 오류 화면을 노출시킨다면 타임아웃을 짧게 잡는 것도 괜찮음
- Query Timeout 설정
  - Connect Timeout과 거의 동일
  - 타임아웃 발생 시 동일 쿼리를 반복적으로 요청한다면 오히려 DB에 부담이 됨
  - 쿼리 재요청을 하지 않고 타임아웃을 짧게 잡는 것도 괜찮음
- Idle Timeout 설정
  - Idle Connection? 커넥션 풀에서 오래 방치된 커넥션
  - 애플리케이션 서버에서 Idle Connection에 접근하면 에러가 발생할 수 있음
    - 커넥션을 사용할 때 유효성을 검증하는 기능을 최대한 활용하라 (이것은 어디서 지원하는 것인지?)
  - 에러 회피를 목적으로 Idle Timeout을 너무 잛게 잡기보다는, 최소 20~30분 이상 설정하는 것을 권장함
    - 커넥션 내에 캐시된 객체들(e.g. Prepared Statement 등)이 모두 사라짐으로써 발생하는 오버헤드를 방지 
  - Idle Connection으로 인한 에러는 꽤 자주 발생할 수 있으므로 핵심 기능의 경우 Retry 로직을 구현해야 한다

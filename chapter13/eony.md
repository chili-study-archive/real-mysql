# 콜레이션

## 콜레이션이란?
- 문자를 비교하거나 정렬할 때 사용되는 규칙
- 문자집합(Charset)에 종속적
- MySQL에서 모든 문자열 타입 컬럼은 독립적인 문자집합과 콜레이션을 가질 수 있음
- 사용자가 지정하지 않으면 서버에 설정된 디폴트 콜레이션이 자동 설정됨

## 콜레이션 종류
- `SHOW COLLATION` 명령으로 사용 가능한 콜레이션 목록 확인 가능

MySQL의 콜레이션 네이밍 컨밴션

{문자집합} _ {언어종속} _ {UCA 버전} _ {민감도}

- 문자집합
    - uft8mb4, utf8mb3, latin1 등...
- 언어종속(선택적 속성, 생략 가능)
    - 특정 언어에 대해 해당 언어에서 정의한 정렬 순서에 의해 정렬 및 비교를 수행
    - locale_code 혹은 language로 표시
- UCA 버전(선택적 속성, 생략 가능)
    - Unicode Collation Algorithm Version
    - 유니코드 기반의 문자집합에 속하는 콜레이션에서 사용하는 문자열 비교 알고리즘
- 민감도
    - Accent-sensitive, Case-sensitive, Binary 등 민감도 속성이 표시됨

## 콜레이션 동작 방식

문자 데이터를 저장하는 방법
- 유니코드 기준
    - 데이터 저장
        - 해당 문자열에 해당하는 코드 포인트 값을 인코딩해서 저장

    - 데이터 비교
        - DUCET에 정의된 가중치 값을 바탕으로 비교
            - Default Unicode Collation Element Table
            - 유니코드 문자별로 가중치 값이 정의되어 있는 시트
        - 가중치 값은 Primary(기본 문자 비교) -> Secondary(악센트 구분) -> Tertiary(대소문자 구분)과 같이 단계적으로 구성됨
        - 콜레이션에 따라 사용되는 가중치 값이 달라짐
            - 민감도에 따라 특정 가중치가 존재하지 않을 수 있음
                - EX) ai_cs이면 Secondary(악센트) 가중치 값이 없지만 Tertiary(대소문자 구분) 가중치 값은 존재함
        - 한글 음절은 분해하여 가중치 값을 조합한 후 비교
        - `WEIGHT_STRING()`을 통해 문자열의 갖우치 값 확인 가능

## 콜레이션 설정
- 글로벌, 데이터베이스, 테이블, 개별 컬럼 단위까지 지정 가능
- 기본적으로 서버는 utf8mb4 문자집합 + utf8mb4_0900_ai_ci 콜레이션으로 설정됨
- character_set_server & collation_server 설정 변수를 통해 원하는 문자집합 및 콜레이션 설정 가능

## 콜레이션 사용 시 주의사항
(1) 서로 다른 콜레이션을 가진 컬럼들 값 비교 시 에러 발생함
- 동일한 하나의 콜레이션을 사용하도록 변경
- 쿼리 자체에 `COLLATE` 키워드를 사용하여 원하는 콜레이션을 설정할 수 있음
    - `SELECT ... WHERE name COLLATE utf8mb4_general_c = 'name'`

(2) 쿼리 WHERE절에서 콜레이션 변경 시 일반 인덱스 사용이 불가함
- collate 자체를 함수 기반 인덱스로 걸어 해결할수도 있음

```sql
CREATE TABLE t1 (
...
KEY ix_name (((name collate utf8mb4_general_ci)))
)
```

(3) 고유키(PK, UK)도 콜레이션의 영향을 받음
- 만약 PK가 case-sensitive 콜레이션이면 'name', 'NAME' 두 개를 다른 값으로 인식
- 고유성에도 영향을 끼친다는 의미이므로 콜레이션 확인 필수적임

(4) 기본 콜레이션(utf8mb4_0900_ai_ci)에서의 한글 비교 문제
- "가"와 "ㄱㅏ"가 동일하게 인식됨
- "각"과 "가ㄱ"은 동일하게 인식되지 않음

이유?
- 한글 각각의 문자별 가중치와 초성/중성/종성으로 나누어진 가중치 값 계산이 다르기 때문
- 정확한 한글 구분이 필요한 경우 다른 콜레이션을 사용하거나 쿼리 WHERE 절에서 비교 조건을 추가해서 사용 가능

(5) 대소문자 구분을 위한 콜레이션 설정
- 기본 콜레이션은 대소문자를 구분하지 않음(ci)
- utf8mb4 문자집합에 속한 콜레이션 중 대소문자를 구분하는 콜레이션
    - utf8mb4_bin
    - utf8mb4_0900_bin
    - utf8mb4_0900_ac_cs
        - 세 가지 중 각자 상황에 맞는 걸 고르는 것이 좋음

- 후행 공백 인식을 원치 않는 경우
    - 'a '와 'a'를 동일하게 보길 원함 -> utf8mb4_bin
- 후행 공백 인식을 원하거나 특별히 상관이 없으면서
    - 단순히 대소문자가 잘 구분되는 정도면 충분함 -> utf8mb4_0900_as_cs
    - 모든 문자를 명확하게 구분하고 싶은 경우 -> utf8mb4_0900_bin